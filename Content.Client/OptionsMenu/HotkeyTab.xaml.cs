using Content.Client.Audio;
using Content.Client.UI.StyleSheets.Default;
using Content.Shared.Input;
using Robust.Client.AutoGenerated;
using Robust.Client.Input;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Input;
using Robust.Shared.Timing;
using Robust.Shared.Utility;
using System.Linq;
using System.Text.RegularExpressions;
using static Robust.Client.Input.Keyboard;
using static Robust.Client.UserInterface.Controls.BoxContainer;

namespace Content.Client.OptionsMenu
{
	[GenerateTypedNameReferences]
	public sealed partial class HotkeyTab : Control
	{
		[Dependency] private readonly IInputManager _inputManager = default!;

		private readonly List<Action> _keybindResets = new();

		private readonly List<Key> _heldKeys = new();

		private readonly List<HotKeyBox> _hoykeyBoxes = new();

		private bool _currentlyRebinding = false;
		private BoundKeyFunction _rebindingFunction;

		public HotkeyTab()
		{
			RobustXamlLoader.Load(this);
			IoCManager.InjectDependencies(this);

			foreach (var hotkeySet in GetHotkeySets())
			{
				KeybindsContainer.AddChild(new Label
					{ 
						Text = hotkeySet.CategoryName, StyleClasses = { DefaultContentStyle.StyleClassHeaderFont }
					});

				foreach (var function in hotkeySet.Functions)
				{
					AddHotkeyBox(function);
				}
			}
			UpdateAllHotkeyBoxes();
			ResetAllButton.OnButtonUp += _ => ResetAllKeybinds();
			AudioHelpers.AddButtonSound(AudioHelpers.PresetSoundFiles.Pop, new List<BaseButton>
			{
				ResetAllButton
			});

			void AddHotkeyBox(BoundKeyFunction function)
			{
				var hotkeyBox = new HotKeyBox(function);
				_hoykeyBoxes.Add(hotkeyBox);
				KeybindsContainer.AddChild(hotkeyBox);

				hotkeyBox.ResetButton.OnButtonUp += _ => ResetKeybind(hotkeyBox);
				hotkeyBox.RebindButton.OnButtonUp += _ => StartRebinding(hotkeyBox);

				AudioHelpers.AddButtonSound(AudioHelpers.PresetSoundFiles.Pop, new List<BaseButton>
				{
					hotkeyBox.ResetButton,
					hotkeyBox.RebindButton
				});
			}
		}

		private void ResetAllKeybinds()
		{
			foreach (var hotkeyBox in _hoykeyBoxes)
			{
				ResetKeybind(hotkeyBox);
			}
		}

		private void ResetKeybind(HotKeyBox hotkeyBox)
		{
			//Reseting the keybind is defered to the next frame
			//Removing a keybind in the middle of InputManager handling a key input causes a crash
			_keybindResets.Add(() =>
			{
				_inputManager.ResetBindingsFor(hotkeyBox.Function);
				_inputManager.SaveToUserData();
				UpdateHotkeyBox(hotkeyBox);
			});
		}

		private void UpdateAllHotkeyBoxes()
		{
			foreach (var hotkeyBox in _hoykeyBoxes)
			{
				UpdateHotkeyBox(hotkeyBox);
			}
		}

		private void UpdateHotkeyBox(HotKeyBox hotkeyBox)
		{
			hotkeyBox.RebindButton.Disabled = _currentlyRebinding;

			hotkeyBox.RebindButton.Text = _rebindingFunction == hotkeyBox.Function ?
				"Rebinding..." : _inputManager.GetKeyBinding(hotkeyBox.Function).GetKeyString();

			hotkeyBox.ResetButton.Disabled = !_inputManager.IsKeyFunctionModified(hotkeyBox.Function);
		}

		private void StartRebinding(HotKeyBox rebindingHotkeyBox)
		{
			_currentlyRebinding = true;
			_rebindingFunction = rebindingHotkeyBox.Function;

			UpdateAllHotkeyBoxes();

			KeyEventAction handler = (_, _) => { };
			handler = (keyEvent, type) => InterceptInput(keyEvent, type, handler, rebindingHotkeyBox);
			_inputManager.FirstChanceOnKeyEvent += handler;
		}

		private void InterceptInput(KeyEventArgs keyEvent, KeyEventType type, KeyEventAction handler, HotKeyBox rebindingHotkeyBox)
		{
			if (type == KeyEventType.Down)
			{
				_heldKeys.Add(keyEvent.Key);
				return;
			}
			else if (type == KeyEventType.Repeat)
			{
				return;
			}
			if (!_heldKeys.Any())
			{
				return;
			}

			RebindHotkey(rebindingHotkeyBox.Function, _heldKeys);
			_inputManager.FirstChanceOnKeyEvent -= handler;
			_heldKeys.Clear();
			_currentlyRebinding = false;
			_rebindingFunction = default;
			UpdateAllHotkeyBoxes();

			AudioHelpers.TryPlayGuiEffect(AudioHelpers.PresetSoundFiles.Pop);
		}

		private void RebindHotkey(BoundKeyFunction function, List<Key> newKeys)
		{
			var currentBind = _inputManager.GetKeyBinding(function);

			newKeys.TryGetValue(0, out var primaryKey);
			newKeys.TryGetValue(1, out var mod1);
			newKeys.TryGetValue(2, out var mod2);
			newKeys.TryGetValue(3, out var mod3);

			var newBind = new KeyBindingRegistration
			{
				Function = currentBind.Function,
				BaseKey = primaryKey,
				Mod1 = mod1,
				Mod2 = mod2,
				Mod3 = mod3,
				Priority = currentBind.Priority,
				Type = currentBind.BindingType,
				CanFocus = currentBind.CanFocus,
				CanRepeat = currentBind.CanRepeat,
			};
			_inputManager.RemoveBinding(currentBind);
			_inputManager.RegisterBinding(newBind);
			_inputManager.SaveToUserData();
		}

		protected override void FrameUpdate(FrameEventArgs args)
		{
			base.FrameUpdate(args);

			foreach (var command in _keybindResets)
			{
				command();
			}
			_keybindResets.Clear();
		}

		private sealed class HotKeyBox : Control
		{
			public readonly Button RebindButton;
			public readonly Button ResetButton;
			public readonly BoundKeyFunction Function;

			public HotKeyBox(BoundKeyFunction function)
			{
				IoCManager.InjectDependencies(this);
				Function = function;

				var functionLabel = new Label
				{
					Text = FunctionNameToString(Function.FunctionName),
					MinWidth = 300f,
				};
				RebindButton = new Button { MinWidth = 150f };
				ResetButton = new Button { Text = "Reset" };
				AddChild(new BoxContainer
				{
					Orientation = LayoutOrientation.Horizontal,
					Children =
					{
						functionLabel,
						RebindButton,
						ResetButton,
					}
				});

				string FunctionNameToString(string str)
				{
					var regex = new Regex("(?<!^)([A-Z][a-z]|(?<=[a-z])[A-Z])", RegexOptions.Compiled);
					return regex.Replace(str, " $1");

				} 
			}
		}

		private List<HotkeySet> GetHotkeySets()
		{
			var movementKeys = new HotkeySet("Movement",
				new List<BoundKeyFunction>
				{
					EngineKeyFunctions.MoveUp,
					EngineKeyFunctions.MoveDown,
					EngineKeyFunctions.MoveLeft,
					EngineKeyFunctions.MoveRight,
				});
			var mappingKeys = new HotkeySet("Mapping",
				new List<BoundKeyFunction>
				{
					ContentKeyFunctions.OpenMappingCommandWindow,
					ContentKeyFunctions.OpenEntitySpawnWindow,
					ContentKeyFunctions.OpenTileSpawnWindow,
					EngineKeyFunctions.EditorPlaceObject,
					EngineKeyFunctions.EditorCancelPlace,
					EngineKeyFunctions.EditorGridPlace,
					EngineKeyFunctions.EditorLinePlace,
					EngineKeyFunctions.EditorRotateObject,
				});
			var devKeys = new HotkeySet("Development",
				new List<BoundKeyFunction>
				{
					EngineKeyFunctions.ShowDebugConsole,
					EngineKeyFunctions.ShowDebugMonitors,
					EngineKeyFunctions.HideUI,
				});

			return new List<HotkeySet>
			{
				movementKeys,
				mappingKeys,
				devKeys,
			};
		}

		private sealed class HotkeySet
		{
			public string CategoryName { get; private set; }

			public List<BoundKeyFunction> Functions { get; private set; }

			public HotkeySet(string categoryName, List<BoundKeyFunction> functions)
			{
				CategoryName = categoryName;
				Functions = functions;
			}
		}
	}
}
