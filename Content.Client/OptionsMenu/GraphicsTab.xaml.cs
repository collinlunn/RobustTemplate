using Content.Client.Audio;
using Content.Shared.ContentCVars;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared;
using Robust.Shared.Configuration;
using Robust.Shared.Utility;
using static Robust.Client.Input.Mouse;

namespace Content.Client.OptionsMenu
{
	[GenerateTypedNameReferences]
	public sealed partial class GraphicsTab : Control
	{
		[Dependency] private readonly IConfigurationManager _cfg = default!;

		private readonly List<float> _uiSizes = new() { 0.5f, 1, 1.5f, 2 };

		private ContentRadioOptions<float> _uiSizeRadio;

		public GraphicsTab()
		{
			RobustXamlLoader.Load(this);
			IoCManager.InjectDependencies(this);

			ApplyButton.OnPressed += _ => ApplyPressed();
			AudioHelpers.AddButtonSound(AudioHelpers.PresetSoundFiles.Pop, new List<BaseButton>
			{
				ApplyButton,
				VSyncCheckBox,
				FullscreenCheckBox,
				FpsCounterCheckBox,
				PingCounterCheckBox
			});

			_uiSizeRadio = new();
			_uiSizeRadio.AddButton($"OS Auto: { UserInterfaceManager.DefaultUIScale * 100}%", 0);
			foreach (var size in _uiSizes)
			{
				_uiSizeRadio.AddButton($"{size * 100}%", size);
			}
			UiSizeBox.AddChild(_uiSizeRadio);

			AudioHelpers.AddButtonSound(AudioHelpers.PresetSoundFiles.Pop, _uiSizeRadio.Buttons);

			UpdateButtons();
		}

		public void UpdateButtons()
		{
			VSyncCheckBox.Pressed = _cfg.GetCVar(CVars.DisplayVSync);
			FullscreenCheckBox.Pressed = _cfg.GetCVar(CVars.DisplayWindowMode) == (int)WindowMode.Fullscreen;
			FpsCounterCheckBox.Pressed = _cfg.GetCVar(ContentCVars.HudFpsVisible);
			PingCounterCheckBox.Pressed = _cfg.GetCVar(ContentCVars.HudPingVisible);
			
			var setRadio = _uiSizeRadio.SetValue(_cfg.GetCVar(CVars.DisplayUIScale));
			DebugTools.Assert(setRadio);
		}

		private void ApplyPressed()
		{
			_cfg.SetCVar(CVars.DisplayVSync, VSyncCheckBox.Pressed);
			_cfg.SetCVar(CVars.DisplayWindowMode,
						 (int)(FullscreenCheckBox.Pressed ? WindowMode.Fullscreen : WindowMode.Windowed));
			_cfg.SetCVar(ContentCVars.HudFpsVisible, FpsCounterCheckBox.Pressed);
			_cfg.SetCVar(ContentCVars.HudPingVisible, PingCounterCheckBox.Pressed);
			_cfg.SetCVar(CVars.DisplayUIScale, _uiSizeRadio.SelectedValue);
			_cfg.SaveToFile();
		}

		public void OnClosed()
		{
			//if apply wasn't preessed, the buttons will look incorrect on next open
			UpdateButtons();
		}
	}
}
